<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nova Microfinance ‚Äî IT Ops</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&family=Cinzel:wght@600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0e1a;--surface:#111827;--surface2:#1a2234;--surface3:#1e293b;
  --border:#1e293b;--border-light:#2d3a4f;--border-focus:#6366f1;
  --text:#e2e8f0;--text-muted:#8896ab;--text-dim:#4a5568;
  --critical:#ef4444;--critical-bg:rgba(239,68,68,.13);--critical-glow:rgba(239,68,68,.35);
  --high:#f59e0b;--high-bg:rgba(245,158,11,.13);--high-glow:rgba(245,158,11,.35);
  --medium:#3b82f6;--medium-bg:rgba(59,130,246,.13);--medium-glow:rgba(59,130,246,.35);
  --enhancement:#8b5cf6;--enhancement-bg:rgba(139,92,246,.13);--enhancement-glow:rgba(139,92,246,.35);
  --design:#06b6d4;--design-bg:rgba(6,182,212,.13);--design-glow:rgba(6,182,212,.35);
  --today:#10b981;--done:#10b981;--accent:#6366f1;--accent-bg:rgba(99,102,241,.15);
  --gold:#f59e0b;--gold-glow:rgba(245,158,11,.6);
  --overdue:#3a3f4b;--overdue-bar:#2a2e38;--overdue-text:#6b7280;
  --row-h:44px;--domain-h:32px;--hdr-h:50px;
}
[data-theme=light]{
  --bg:#f0f4ff;--surface:#ffffff;--surface2:#e8eeff;--surface3:#dde5ff;
  --border:#c7d2fe;--border-light:#a5b4fc;--border-focus:#6366f1;
  --text:#1e1b4b;--text-muted:#4338ca;--text-dim:#818cf8;
  --critical:#dc2626;--critical-bg:rgba(220,38,38,.1);--critical-glow:rgba(220,38,38,.25);
  --high:#d97706;--high-bg:rgba(217,119,6,.1);--high-glow:rgba(217,119,6,.25);
  --medium:#2563eb;--medium-bg:rgba(37,99,235,.1);--medium-glow:rgba(37,99,235,.25);
  --enhancement:#7c3aed;--enhancement-bg:rgba(124,58,237,.1);--enhancement-glow:rgba(124,58,237,.25);
  --design:#0891b2;--design-bg:rgba(8,145,178,.1);--design-glow:rgba(8,145,178,.25);
  --today:#059669;--done:#059669;--accent:#4f46e5;--accent-bg:rgba(79,70,229,.12);
  --gold:#d97706;--gold-glow:rgba(217,119,6,.5);
  --overdue:#c0c8d8;--overdue-bar:#9aa0b0;--overdue-text:#9099a8;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;display:flex;flex-direction:column;font-size:13px}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#loginOverlay{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at 50% 40%,rgba(99,102,241,.15),var(--bg) 70%)}
.login-card{background:linear-gradient(145deg,var(--surface),var(--surface2));border:1px solid var(--border-light);border-radius:20px;padding:44px 48px;width:420px;text-align:center;box-shadow:0 0 60px rgba(99,102,241,.15),0 24px 48px rgba(0,0,0,.4)}
.login-brand .company{font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px}
.login-brand .logo{font-family:'Cinzel',serif;font-size:26px;font-weight:600;letter-spacing:2px;background:linear-gradient(135deg,#a78bfa,#6366f1,#38bdf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 12px rgba(99,102,241,.5))}
.login-brand .tagline{font-size:11px;font-weight:600;letter-spacing:4px;text-transform:uppercase;color:var(--gold);margin-top:6px;text-shadow:0 0 12px var(--gold-glow);font-family:'Cinzel',serif}
.login-divider{width:40px;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);margin:18px auto}
.login-card p{font-size:13px;color:var(--text-muted);margin-bottom:22px;line-height:1.6;font-weight:500}
.login-field{width:100%;padding:12px 16px;border-radius:9px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:14px;outline:none;font-family:inherit;margin-bottom:12px;transition:border-color .2s;font-weight:500}
.login-field:focus{border-color:var(--border-focus);box-shadow:0 0 0 3px rgba(99,102,241,.15)}
.login-btn{width:100%;padding:13px;border-radius:9px;border:none;background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;font-size:14px;font-weight:800;cursor:pointer;font-family:inherit;letter-spacing:.5px;transition:all .2s;box-shadow:0 4px 16px rgba(99,102,241,.35)}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(99,102,241,.5)}
.login-footer{margin-top:20px;font-size:10px;color:var(--text-dim);letter-spacing:1px}

/* ‚îÄ‚îÄ SYNC BAR ‚îÄ‚îÄ */
#syncBar{display:none;align-items:center;gap:10px;padding:5px 24px;background:rgba(99,102,241,.05);border-bottom:1px solid var(--border);flex-shrink:0;font-size:11px;color:var(--text-muted)}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--text-dim);flex-shrink:0}
.sync-dot.ok{background:var(--done);box-shadow:0 0 6px var(--done)}
.sync-dot.syncing{background:var(--high);animation:pulse 1s infinite}
.sync-dot.error{background:var(--critical)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.spacer{flex:1}
.vvv-badge{font-family:'Cinzel',serif;font-size:9px;font-weight:600;letter-spacing:2px;color:var(--gold);text-shadow:0 0 8px var(--gold-glow);padding:2px 8px;border:1px solid rgba(245,158,11,.25);border-radius:4px;background:rgba(245,158,11,.05)}
.sync-user-badge{padding:2px 10px;border-radius:4px;background:var(--accent-bg);border:1px solid rgba(99,102,241,.3);color:var(--accent);font-weight:800;font-size:10px}
.sync-btn{padding:3px 11px;border-radius:5px;border:1px solid var(--border);background:var(--surface2);color:var(--text-muted);font-size:10px;font-weight:700;cursor:pointer;transition:all .2s}
.sync-btn:hover{background:var(--accent-bg);border-color:var(--accent);color:var(--text)}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{display:none;padding:12px 24px 8px;border-bottom:1px solid var(--border);flex-shrink:0;background:linear-gradient(180deg,rgba(99,102,241,.07),transparent);flex-wrap:wrap;align-items:flex-start;gap:10px;justify-content:space-between}
.header-left h1{font-size:18px;font-weight:800;letter-spacing:-.5px;background:linear-gradient(135deg,#e2e8f0,#a5b4fc 50%,#38bdf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
[data-theme=light] .header-left h1{background:linear-gradient(135deg,#1e1b4b,#4f46e5,#0891b2);-webkit-background-clip:text}
.subtitle{font-size:11px;color:var(--text-muted);margin-top:2px;font-weight:600}
.stats-bar{display:flex;gap:5px;margin-top:7px;flex-wrap:wrap}
.stat-chip{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:5px;font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;border:1px solid}
.stat-chip .dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.stat-chip.critical{background:var(--critical-bg);border-color:rgba(239,68,68,.3);color:var(--critical)}.stat-chip.critical .dot{background:var(--critical)}
.stat-chip.high{background:var(--high-bg);border-color:rgba(245,158,11,.3);color:var(--high)}.stat-chip.high .dot{background:var(--high)}
.stat-chip.medium{background:var(--medium-bg);border-color:rgba(59,130,246,.3);color:var(--medium)}.stat-chip.medium .dot{background:var(--medium)}
.stat-chip.enhancement{background:var(--enhancement-bg);border-color:rgba(139,92,246,.3);color:var(--enhancement)}.stat-chip.enhancement .dot{background:var(--enhancement)}
.stat-chip.design{background:var(--design-bg);border-color:rgba(6,182,212,.3);color:var(--design)}.stat-chip.design .dot{background:var(--design)}
.stat-chip.overdue{background:rgba(58,63,75,.3);border-color:rgba(90,96,112,.4);color:var(--overdue-text)}.stat-chip.overdue .dot{background:var(--overdue)}
.header-actions{display:flex;gap:7px;flex-wrap:wrap;align-items:flex-start;padding-top:2px}
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border-radius:7px;font-size:11px;font-weight:700;border:1px solid var(--border);background:var(--surface2);color:var(--text-muted);cursor:pointer;transition:all .2s;font-family:inherit}
.btn:hover{background:var(--accent-bg);border-color:var(--accent);color:var(--text)}
.btn.primary{background:linear-gradient(135deg,#6366f1,#4f46e5);border-color:var(--accent);color:#fff;box-shadow:0 2px 10px rgba(99,102,241,.3)}
.btn.primary:hover{box-shadow:0 4px 16px rgba(99,102,241,.5);transform:translateY(-1px)}
.btn.danger{border-color:rgba(239,68,68,.3);color:var(--critical)}
.btn.danger:hover{background:rgba(239,68,68,.12)}
.btn svg{width:13px;height:13px}

/* ‚îÄ‚îÄ MAIN TABS ‚îÄ‚îÄ */
.main-tabs{display:none;gap:2px;padding:0 24px;background:var(--surface);border-bottom:2px solid var(--border);flex-shrink:0}
.main-tab{padding:10px 18px;font-size:12px;font-weight:700;cursor:pointer;border-bottom:2px solid transparent;color:var(--text-muted);transition:all .2s;margin-bottom:-2px;display:flex;align-items:center;gap:6px}
.main-tab:hover{color:var(--text)}
.main-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.main-tab .tc{font-size:10px;padding:1px 6px;border-radius:10px;background:var(--accent-bg);color:var(--accent);font-family:'JetBrains Mono',monospace}
.main-tab.active .tc{background:var(--accent);color:#fff}

/* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
#toolbar{display:none;align-items:center;gap:7px;padding:7px 24px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;flex-wrap:wrap}
.filter-btn{padding:4px 12px;border-radius:5px;font-size:11px;font-weight:600;background:var(--surface2);border:1px solid var(--border);color:var(--text-muted);cursor:pointer;transition:all .2s}
.filter-btn:hover,.filter-btn.active{background:var(--accent-bg);border-color:var(--accent);color:var(--text)}
.filter-btn.active.critical{background:var(--critical-bg);border-color:var(--critical);color:var(--critical)}
.filter-btn.active.high{background:var(--high-bg);border-color:var(--high);color:var(--high)}
.filter-btn.active.medium{background:var(--medium-bg);border-color:var(--medium);color:var(--medium)}
.filter-btn.active.enhancement{background:var(--enhancement-bg);border-color:var(--enhancement);color:var(--enhancement)}
.filter-btn.active.design{background:var(--design-bg);border-color:var(--design);color:var(--design)}
.tb-sep{width:1px;height:20px;background:var(--border);margin:0 4px}
.week-nav{display:flex;align-items:center;gap:7px;margin-left:auto}
.week-label{font-size:11px;font-weight:700;color:var(--text);padding:5px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;font-family:'JetBrains Mono',monospace;min-width:230px;text-align:center}
.week-btn{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text-muted);cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.week-btn:hover{background:var(--accent-bg);border-color:var(--accent);color:var(--text)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VIEWS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#ganttView,#kanbanView{display:none;flex:1;min-height:0}
#ganttView.active{display:flex;flex-direction:row;overflow:hidden}
#kanbanView.active{display:flex;flex-direction:column;overflow:hidden}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   KANBAN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* Outer scroll container ‚Äî full vertical scroll */
#kanbanScroll{flex:1;overflow:auto;padding:16px 20px 24px}
/* The board row ‚Äî horizontal flex, does NOT scroll on its own */
#kanbanBoard{display:flex;gap:14px;align-items:flex-start;width:max-content;min-height:100%}

.kb-col{width:290px;flex-shrink:0;display:flex;flex-direction:column;background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:visible}
.kb-col.col-dragging{opacity:.5;border:2px dashed var(--accent)}
.kb-col.col-drag-over{border:2px dashed var(--today);background:rgba(16,185,129,.05)}
.kb-col-header{padding:12px 14px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0;cursor:grab;border-radius:12px 12px 0 0;user-select:none}
.kb-col-header:active{cursor:grabbing}
.kb-col-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.kb-col-title{font-size:12px;font-weight:800;letter-spacing:.4px;flex:1}
.kb-col-count{font-size:10px;padding:2px 7px;border-radius:10px;background:var(--surface2);border:1px solid var(--border);font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--text-muted)}
.kb-drag-hint{font-size:9px;color:var(--text-dim);opacity:.6;flex-shrink:0}

/* Cards container ‚Äî no overflow clip, full height shows */
.kb-cards{padding:10px;display:flex;flex-direction:column;gap:10px}

.kb-card{background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:13px 13px 11px;cursor:pointer;transition:border-color .15s,box-shadow .15s,transform .15s;position:relative;overflow:hidden}
.kb-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px}
.kb-card.critical::before{background:var(--critical);box-shadow:0 0 8px var(--critical-glow)}
.kb-card.high::before{background:var(--high)}
.kb-card.medium::before{background:var(--medium)}
.kb-card.enhancement::before{background:var(--enhancement)}
.kb-card.design::before{background:var(--design)}
.kb-card.overdue-card::before{background:var(--overdue)!important;box-shadow:none!important}
.kb-card:hover{border-color:var(--border-focus);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.35)}
.kb-card-id{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;color:var(--text-muted);margin-bottom:5px;padding-left:4px}
.kb-card-name{font-size:12px;font-weight:700;color:var(--text);line-height:1.45;margin-bottom:10px;padding-left:4px}
.kb-card-system{font-size:10px;color:var(--text-muted);font-weight:500;padding-left:4px;margin-bottom:8px;font-style:italic;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.kb-card-footer{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;padding-left:4px}
.kb-p-badge{font-size:9px;font-weight:800;padding:3px 8px;border-radius:4px;letter-spacing:.4px;flex-shrink:0}
.kb-p-badge.critical{background:var(--critical);color:#fff}
.kb-p-badge.high{background:var(--high);color:#000}
.kb-p-badge.medium{background:var(--medium);color:#fff}
.kb-p-badge.enhancement{background:var(--enhancement);color:#fff}
.kb-p-badge.design{background:var(--design);color:#fff}
.kb-p-badge.overdue{background:var(--overdue);color:var(--overdue-text)}
.kb-owners{display:flex;gap:3px;flex-wrap:wrap;align-items:center}
.kb-owner-dot{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;color:#fff;border:2px solid var(--surface2);flex-shrink:0}
.kb-owner-name{font-size:10px;font-weight:600;color:var(--text-muted)}
.kb-overdue-tag{font-size:9px;font-weight:700;color:var(--overdue-text);background:rgba(58,63,75,.5);padding:2px 7px;border-radius:3px;letter-spacing:.3px}
.kb-week-tag{font-size:9px;font-weight:600;color:var(--text-dim);background:var(--surface);border:1px solid var(--border);padding:2px 6px;border-radius:3px}
.kb-empty{text-align:center;padding:28px 16px;color:var(--text-dim);font-size:11px;font-weight:600;border:2px dashed var(--border);border-radius:7px;margin:4px}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GANTT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#leftPanel{flex-shrink:0;display:flex;flex-direction:column;border-right:2px solid var(--border-light);background:var(--surface);position:relative;z-index:4}
#leftHeader{display:flex;align-items:stretch;height:var(--hdr-h);flex-shrink:0;background:var(--surface2);border-bottom:1px solid var(--border);user-select:none;overflow:hidden}
.lh-cell{display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.9px;color:var(--text);border-right:1px solid var(--border);padding:0 8px;flex-shrink:0;position:relative;white-space:nowrap}
.lh-cell.lh-name{flex:1;justify-content:flex-start;min-width:0}
.lh-cell:last-child{border-right:none}
.col-resize{position:absolute;right:0;top:0;bottom:0;width:5px;cursor:col-resize;z-index:5;transition:background .15s}
.col-resize:hover,.col-resize.active{background:var(--accent)}
#leftBody{overflow-y:auto;overflow-x:hidden;flex:1}
#rightPanel{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden}
#timelineHeader{height:var(--hdr-h);overflow:hidden;flex-shrink:0;background:var(--surface2);border-bottom:1px solid var(--border)}
#timelineHeaderInner{display:flex;height:100%}
.day-col-hdr{flex-shrink:0;display:flex;flex-direction:column;align-items:center;justify-content:center;border-right:1px solid var(--border)}
.day-col-hdr.today-col{background:rgba(16,185,129,.1);border-right:1px solid rgba(16,185,129,.4)}
.day-name{font-size:12px;font-weight:800;color:var(--text)}
.day-date{font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;margin-top:2px;font-weight:600}
.today-badge{font-size:8px;font-weight:800;background:var(--today);color:#fff;padding:2px 6px;border-radius:3px;margin-top:3px;letter-spacing:.6px}
#timelineBody{flex:1;overflow:auto;position:relative}
#timelineBodyInner{position:relative}
.left-domain-row{height:var(--domain-h);display:flex;align-items:center;padding:0 12px;background:linear-gradient(90deg,rgba(99,102,241,.1),transparent);border-bottom:1px solid var(--border);font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1.2px;color:var(--accent)}
.left-task-row{display:flex;align-items:stretch;height:var(--row-h);border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s}
.left-task-row:hover{background:rgba(99,102,241,.06)}
.left-task-row.selected{background:rgba(99,102,241,.12);box-shadow:inset 3px 0 0 var(--accent)}
.left-task-row.row-overdue{background:rgba(42,46,56,.3)}
.left-task-row.row-overdue:hover{background:rgba(58,63,75,.25)}
.ltr-cell{display:flex;align-items:center;padding:0 8px;flex-shrink:0;border-right:1px solid var(--border);overflow:hidden}
.ltr-cell.ltr-name{flex:1;min-width:0}
.ltr-cell:last-child{border-right:none}
.task-id-txt{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;color:var(--text-muted);white-space:nowrap}
.task-name-txt{font-size:12px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;width:100%}
.task-name-txt.overdue-name{color:var(--overdue-text)}
.p-badge{display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;padding:3px 6px;border-radius:4px;letter-spacing:.4px;white-space:nowrap;width:100%;text-align:center}
.p-badge.critical{background:var(--critical);color:#fff;box-shadow:0 0 6px var(--critical-glow)}
.p-badge.high{background:var(--high);color:#000}
.p-badge.medium{background:var(--medium);color:#fff}
.p-badge.enhancement{background:var(--enhancement);color:#fff}
.p-badge.design{background:var(--design);color:#fff}
.p-badge.overdue{background:var(--overdue);color:var(--overdue-text);box-shadow:none}
.owner-cell-inner{display:flex;flex-direction:column;gap:2px;justify-content:center;height:100%}
.owner-pip{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:600;color:var(--text);white-space:nowrap}
.owner-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.tl-domain-row{height:var(--domain-h);border-bottom:1px solid var(--border);background:linear-gradient(90deg,rgba(99,102,241,.03),transparent)}
.tl-task-row{height:var(--row-h);border-bottom:1px solid var(--border);position:relative}
.tl-task-row.row-overdue{background:rgba(20,24,33,.5)}
.g-day{position:absolute;top:0;bottom:0;border-right:1px solid rgba(30,41,59,.9);pointer-events:none;z-index:0}
.g-half{position:absolute;top:0;bottom:0;border-right:1px dashed rgba(30,41,59,.45);pointer-events:none;z-index:0}
.g-today{position:absolute;top:0;bottom:0;width:2px;background:rgba(16,185,129,.45);pointer-events:none;z-index:1}
.g-past{position:absolute;top:0;bottom:0;background:rgba(15,18,28,.55);pointer-events:none;z-index:1;left:0}
[data-theme=light] .g-past{background:rgba(200,210,230,.45)}
[data-theme=light] .g-day{border-color:rgba(199,210,254,.8)}
[data-theme=light] .g-half{border-color:rgba(199,210,254,.45)}
.gantt-bar{position:absolute;top:50%;transform:translateY(-50%);height:24px;border-radius:5px;display:flex;align-items:center;padding:0 10px;font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;cursor:grab;overflow:hidden;white-space:nowrap;user-select:none;z-index:2;transition:box-shadow .15s;min-width:28px}
.gantt-bar:hover{z-index:10;box-shadow:0 0 22px rgba(0,0,0,.6)!important}
.gantt-bar.dragging{opacity:.82;cursor:grabbing;z-index:20}
.gantt-bar.critical{background:linear-gradient(135deg,#ef4444,#dc2626);box-shadow:0 0 8px var(--critical-glow),inset 0 1px 0 rgba(255,255,255,.15);color:#fff}
.gantt-bar.high{background:linear-gradient(135deg,#f59e0b,#d97706);box-shadow:0 0 8px var(--high-glow),inset 0 1px 0 rgba(255,255,255,.15);color:#000}
.gantt-bar.medium{background:linear-gradient(135deg,#3b82f6,#2563eb);box-shadow:0 0 8px var(--medium-glow),inset 0 1px 0 rgba(255,255,255,.15);color:#fff}
.gantt-bar.enhancement{background:linear-gradient(135deg,#8b5cf6,#7c3aed);box-shadow:0 0 8px var(--enhancement-glow),inset 0 1px 0 rgba(255,255,255,.15);color:#fff}
.gantt-bar.design{background:linear-gradient(135deg,#06b6d4,#0891b2);box-shadow:0 0 8px var(--design-glow),inset 0 1px 0 rgba(255,255,255,.15);color:#fff;border:1px dashed rgba(255,255,255,.3)}
.gantt-bar.bar-overdue{background:linear-gradient(135deg,#3a3f4b,#2a2e38)!important;box-shadow:none!important;color:var(--overdue-text)!important;border:1px solid rgba(90,96,112,.3)!important;opacity:.8}
.bar-past-overlay{position:absolute;top:0;left:0;bottom:0;background:linear-gradient(135deg,#2a2e38,#22262f);z-index:3;pointer-events:none;border-radius:inherit}
.bar-rz{position:absolute;top:0;bottom:0;width:8px;cursor:col-resize;z-index:5}
.bar-rz.l{left:0;border-radius:5px 0 0 5px}
.bar-rz.r{right:0;border-radius:0 5px 5px 0}
.bar-rz:hover{background:rgba(255,255,255,.25)}
.bar-status{position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:9px;font-weight:800;opacity:.85;z-index:4;pointer-events:none}
.empty-week{display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;color:var(--text-muted);font-size:13px;font-weight:600;gap:10px;opacity:.7}

/* ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ */
.tt{position:fixed;background:var(--surface);border:1px solid var(--border-light);border-radius:10px;padding:13px 15px;font-size:12px;color:var(--text);z-index:300;pointer-events:none;min-width:230px;max-width:340px;box-shadow:0 10px 32px rgba(0,0,0,.5);display:none}
.tt.show{display:block}
.tt-title{font-weight:800;font-size:13px;margin-bottom:8px;line-height:1.3}
.tt-row{display:flex;justify-content:space-between;margin:4px 0;font-size:11px;gap:10px}
.tt-lbl{color:var(--text-muted);font-weight:600}
.tt-val{color:var(--text);font-weight:700;text-align:right}
.tt-overdue{background:rgba(58,63,75,.4);color:var(--overdue-text);padding:4px 8px;border-radius:5px;font-size:10px;font-weight:700;margin-top:6px;text-align:center}

/* ‚îÄ‚îÄ PANEL ‚îÄ‚îÄ */
.panel-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;backdrop-filter:blur(2px)}
.panel-overlay.open{display:block}
.side-panel{position:fixed;top:0;right:-540px;width:520px;height:100vh;background:var(--surface);border-left:1px solid var(--border);z-index:51;transition:right .28s ease;display:flex;flex-direction:column}
.side-panel.open{right:0}
.panel-header{padding:18px 22px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start;flex-shrink:0}
.panel-header h2{font-size:15px;font-weight:800}
.panel-id{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);margin-top:3px;font-weight:600}
.panel-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.panel-tab{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:700;cursor:pointer;border-bottom:2px solid transparent;color:var(--text-muted);transition:all .2s}
.panel-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.close-btn{width:30px;height:30px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;transition:all .2s}
.close-btn:hover{background:rgba(239,68,68,.12);border-color:var(--critical);color:var(--critical)}
.panel-body{flex:1;overflow-y:auto;padding:16px 22px}
.tab-content{display:none}.tab-content.active{display:block}
.field-group{margin-bottom:13px}
.field-label{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.9px;color:var(--text-muted);margin-bottom:5px;display:block}
.field-input{width:100%;padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-family:inherit;font-size:13px;font-weight:500;transition:border-color .2s;outline:none}
.field-input:focus{border-color:var(--border-focus);box-shadow:0 0 0 2px rgba(99,102,241,.12)}
textarea.field-input{min-height:54px;resize:vertical;line-height:1.5}
select.field-input{cursor:pointer}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:11px}
.owners-container{display:flex;flex-wrap:wrap;gap:5px;margin-top:4px}
.owner-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 9px;border-radius:5px;font-size:11px;font-weight:600;background:var(--surface2);border:1px solid var(--border);color:var(--text)}
.owner-chip .rm{width:13px;height:13px;border-radius:50%;border:none;background:rgba(239,68,68,.2);color:var(--critical);cursor:pointer;font-size:9px;display:flex;align-items:center;justify-content:center}
.owner-chip .rm:hover{background:rgba(239,68,68,.5)}
.add-row{display:flex;gap:5px;margin-top:5px}
.add-inp{flex:1;padding:7px 10px;border-radius:5px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px;outline:none;font-family:inherit}
.add-inp:focus{border-color:var(--border-focus)}
.panel-footer{padding:12px 22px;border-top:1px solid var(--border);display:flex;gap:7px;justify-content:space-between;flex-shrink:0}
.comment{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:11px 13px;margin-bottom:9px}
.comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.comment-author{font-size:11px;font-weight:800;color:var(--accent)}
.comment-ts{font-size:9px;color:var(--text-dim)}
.comment-text{font-size:12px;line-height:1.6;font-weight:500}
.comment-del{font-size:10px;color:var(--text-muted);background:none;border:none;cursor:pointer;padding:0;font-family:inherit;font-weight:700;margin-top:5px;display:block}
.comment-del:hover{color:var(--critical)}
.comment-form textarea{width:100%;padding:9px 11px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px;min-height:64px;resize:vertical;font-family:inherit;outline:none;font-weight:500}
.comment-form textarea:focus{border-color:var(--border-focus)}
.history-item{display:flex;gap:9px;padding:8px 0;border-bottom:1px solid var(--border)}
.history-icon{width:26px;height:26px;border-radius:5px;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.history-action{font-size:10px;font-weight:700}
.history-meta{font-size:9px;color:var(--text-muted);margin-top:1px}
.history-diff{display:flex;gap:5px;margin-top:3px;font-size:9px;flex-wrap:wrap}
.h-old{background:rgba(239,68,68,.1);color:var(--critical);padding:1px 5px;border-radius:3px;text-decoration:line-through;font-weight:600}
.h-new{background:rgba(16,185,129,.1);color:var(--done);padding:1px 5px;border-radius:3px;font-weight:600}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:60;backdrop-filter:blur(3px);align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:13px;width:500px;max-height:88vh;overflow-y:auto}
.modal-header{padding:18px 22px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-header h2{font-size:16px;font-weight:800}
.modal-body{padding:18px 22px}
.modal-footer{padding:12px 22px;border-top:1px solid var(--border);display:flex;gap:7px;justify-content:flex-end}
.skeleton{background:linear-gradient(90deg,var(--surface2) 25%,var(--surface3) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:4px;height:40px;margin-bottom:7px}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.toast{position:fixed;bottom:22px;right:22px;padding:10px 18px;border-radius:8px;background:var(--done);color:#fff;font-size:13px;font-weight:700;z-index:400;transform:translateY(70px);opacity:0;transition:all .28s;pointer-events:none;max-width:340px}
.toast.show{transform:translateY(0);opacity:1}
.toast.error{background:var(--critical)}
.toast.info{background:var(--accent)}
</style>
</head>
<body>

<div id="loginOverlay">
  <div class="login-card">
    <div class="login-brand">
      <div class="company">Nova Microfinance</div>
      <div class="logo">IT OPERATIONS</div>
      <div class="tagline">Veni ¬∑ Vidi ¬∑ Vici</div>
    </div>
    <div class="login-divider"></div>
    <p>Gantt + Kanban Board ¬∑ Enter your name to access</p>
    <input class="login-field" id="loginName" placeholder="Your name (e.g. Leo)" maxlength="40" onkeydown="if(event.key==='Enter')login()">
    <button class="login-btn" onclick="login()">Access Board ‚Üí</button>
    <div class="login-footer">Nova Microfinance ¬∑ IT Operations ¬∑ 2026</div>
  </div>
</div>

<div id="syncBar">
  <div class="sync-dot" id="syncDot"></div>
  <span id="syncStatus">Connecting‚Ä¶</span>
  <span class="spacer"></span>
  <span class="vvv-badge">Veni ¬∑ Vidi ¬∑ Vici</span>
  <span class="sync-user-badge" id="userBadge"></span>
  <button class="sync-btn" onclick="syncFromSheet()">‚Üª Refresh</button>
  <button class="sync-btn" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è Light</button>
</div>

<header id="mainHeader">
  <div class="header-left">
    <h1>Nova Microfinance ‚Äî IT Operations</h1>
    <div class="subtitle" id="weekSubtitle"></div>
    <div class="stats-bar" id="statsBar"></div>
  </div>
  <div class="header-actions">
    <button class="btn primary" onclick="openAddModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Issue
    </button>
    <button class="btn" onclick="pushAllToSheet()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/><path d="M5 21h14"/></svg>Push All
    </button>
    <button class="btn" onclick="exportJSON()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export
    </button>
  </div>
</header>

<div class="main-tabs" id="mainTabs">
  <div class="main-tab active" onclick="switchMainTab('gantt')">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="14" x2="21" y2="14"/></svg>
    Gantt Timeline <span class="tc" id="ganttCount">0</span>
  </div>
  <div class="main-tab" onclick="switchMainTab('kanban')">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="12" rx="1"/><rect x="17" y="3" width="5" height="15" rx="1"/></svg>
    Kanban Board <span class="tc" id="kanbanCount">0</span>
  </div>
</div>

<div id="toolbar">
  <div id="filterBtns" style="display:flex;gap:5px;flex-wrap:wrap"></div>
  <div class="tb-sep"></div>
  <div class="week-nav" id="weekNav">
    <button class="week-btn" onclick="changeWeek(-1)">‚Äπ</button>
    <div class="week-label" id="weekLabel"></div>
    <button class="week-btn" onclick="changeWeek(1)">‚Ä∫</button>
  </div>
</div>

<!-- GANTT -->
<div id="ganttView">
  <div id="leftPanel">
    <div id="leftHeader">
      <div class="lh-cell" id="lhId">ID<div class="col-resize" data-col="id"></div></div>
      <div class="lh-cell lh-name" id="lhName">Issue<div class="col-resize" data-col="name"></div></div>
      <div class="lh-cell" id="lhPri">Priority<div class="col-resize" data-col="priority"></div></div>
      <div class="lh-cell" id="lhOwner">Owner<div class="col-resize" data-col="owner"></div></div>
    </div>
    <div id="leftBody"></div>
  </div>
  <div id="rightPanel">
    <div id="timelineHeader"><div id="timelineHeaderInner"></div></div>
    <div id="timelineBody"><div id="timelineBodyInner"></div></div>
  </div>
</div>

<!-- KANBAN -->
<div id="kanbanView">
  <div id="kanbanScroll">
    <div id="kanbanBoard"></div>
  </div>
</div>

<!-- PANEL -->
<div class="panel-overlay" id="panelOverlay" onclick="closePanel()"></div>
<div class="side-panel" id="sidePanel">
  <div class="panel-header">
    <div><h2 id="panelTitle"></h2><div class="panel-id" id="panelId"></div></div>
    <button class="close-btn" onclick="closePanel()">‚úï</button>
  </div>
  <div class="panel-tabs">
    <div class="panel-tab active" onclick="switchTab('details')">Details</div>
    <div class="panel-tab" onclick="switchTab('comments')">Comments</div>
    <div class="panel-tab" onclick="switchTab('history')">History</div>
  </div>
  <div class="panel-body">
    <div id="tab-details" class="tab-content active"></div>
    <div id="tab-comments" class="tab-content"></div>
    <div id="tab-history" class="tab-content"></div>
  </div>
  <div class="panel-footer">
    <button class="btn danger" onclick="deleteTask()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>Delete
    </button>
    <button class="btn primary" onclick="savePanel()">Save & Sync</button>
  </div>
</div>

<!-- ADD MODAL -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-header"><h2>Add New Issue</h2><button class="close-btn" onclick="closeAddModal()">‚úï</button></div>
    <div class="modal-body" id="addModalBody"></div>
    <div class="modal-footer">
      <button class="btn" onclick="closeAddModal()">Cancel</button>
      <button class="btn primary" onclick="addNewTask()">Add & Sync</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="tt" id="tt"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CONFIG={
  APPS_SCRIPT_URL:'https://script.google.com/macros/s/AKfycbyq0yAw4DGWhqA9hBjEnEm33bQ3v897XvjS17G9MLVRJ9m6CJZ7LM5vvmFd69kwR4_J/exec',
  SECRET_KEY:'nova-it-ops-2026-X7k2',
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê KANBAN COLUMN DEFINITIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Chronological workflow order ‚Äî draggable by user
const DEFAULT_KB_COLS=[
  {id:'Identified',   label:'Identified',    dot:'#06b6d4', icon:'üîç'},
  {id:'Investigating',label:'Investigating', dot:'#f59e0b', icon:'üî¨'},
  {id:'Design Phase', label:'Design Phase',  dot:'#8b5cf6', icon:'üé®'},
  {id:'Documenting',  label:'Documenting',   dot:'#3b82f6', icon:'üìù'},
  {id:'Escalated',    label:'Escalated',     dot:'#ef4444', icon:'üö®'},
  {id:'Pending',      label:'Pending',       dot:'#8896ab', icon:'‚è≥'},
  {id:'In Progress',  label:'In Progress',   dot:'#6366f1', icon:'‚öôÔ∏è'},
  {id:'Done',         label:'Done ‚úì',        dot:'#10b981', icon:'‚úÖ'},
  {id:'Cancelled',    label:'Cancelled',     dot:'#4a5568', icon:'üö´'},
];
// Status aliases ‚Üí canonical column id
const STATUS_ALIAS={
  'New':'Identified','Open':'Identified','Bug':'Investigating',
  'Enhancement':'In Progress','Awaiting Dev':'In Progress','Design Needed':'Design Phase',
};
function resolveStatus(s){return STATUS_ALIAS[s]||s||'Identified';}
const ALL_STATUSES=DEFAULT_KB_COLS.map(c=>c.id);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PRIORITIES=['critical','high','medium','enhancement','design'];
const PL={critical:'Critical',high:'High',medium:'Medium',enhancement:'Enhancement',design:'Design / Ph2'};
const PS={critical:'CRITICAL',high:'HIGH',medium:'MEDIUM',enhancement:'ENHANCE',design:'DESIGN'};
const OC={Leo:'#ef4444',Zayyad:'#f59e0b',Charles:'#3b82f6','IT Ops':'#8b5cf6',Sharon:'#ec4899',Compliance:'#06b6d4',Sam:'#10b981',Precious:'#f97316'};
const BASE_MON=new Date(2026,1,17);
const DAY_W=160;
const DNAMES=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MNAMES=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let DATA=[],currentFilter='all',selectedTaskId=null,activeMainTab='gantt';
let currentTheme=localStorage.getItem('novaTheme')||'dark';
let currentUser='',isSyncing=false,weekOffset=0;
let CW=JSON.parse(localStorage.getItem('novaCW')||'null')||{id:90,name:260,priority:105,owner:115};
// Kanban column order (persisted)
let kbColOrder=JSON.parse(localStorage.getItem('novaKbOrder')||'null')||DEFAULT_KB_COLS.map(c=>c.id);

function oc(n){return OC[n]||'#6366f1';}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function getKbCols(){
  // Merge saved order with defaults (handle new cols added later)
  const ordered=kbColOrder.map(id=>DEFAULT_KB_COLS.find(c=>c.id===id)).filter(Boolean);
  DEFAULT_KB_COLS.forEach(c=>{if(!ordered.find(x=>x.id===c.id))ordered.push(c);});
  return ordered;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WEEK ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getWeekDays(off){
  return Array.from({length:7},(_,i)=>{
    const d=new Date(BASE_MON);d.setDate(BASE_MON.getDate()+off*7+i);
    return{label:DNAMES[d.getDay()],date:`${MNAMES[d.getMonth()]} ${d.getDate()}`,full:new Date(d)};
  });
}
function isToday(d){const n=new Date();return d.getFullYear()===n.getFullYear()&&d.getMonth()===n.getMonth()&&d.getDate()===n.getDate();}
function isPast(d){const n=new Date();n.setHours(0,0,0,0);return d<n;}
function getOverdueMetrics(task,days){
  const barStart=task.start*DAY_W,barEnd=(task.start+task.dur)*DAY_W;
  function pxToDate(px){const i=Math.min(Math.floor(px/DAY_W),days.length-1);return days[i]?new Date(days[i].full):null;}
  const sd=pxToDate(barStart),ed=pxToDate(Math.max(barEnd-1,barStart));
  if(!sd||!ed)return{totalPx:barEnd-barStart,pastPx:0,futurePx:barEnd-barStart,isFullyOverdue:false,isPartiallyOverdue:false};
  if(isPast(ed)&&isPast(sd))return{totalPx:barEnd-barStart,pastPx:barEnd-barStart,futurePx:0,isFullyOverdue:true,isPartiallyOverdue:false};
  let todayPx=null;days.forEach((d,i)=>{if(isToday(d.full))todayPx=i*DAY_W;});
  if(todayPx===null){
    if(days.every(d=>isPast(d.full)))return{totalPx:barEnd-barStart,pastPx:barEnd-barStart,futurePx:0,isFullyOverdue:true,isPartiallyOverdue:false};
    return{totalPx:barEnd-barStart,pastPx:0,futurePx:barEnd-barStart,isFullyOverdue:false,isPartiallyOverdue:false};
  }
  if(barEnd<=todayPx)return{totalPx:barEnd-barStart,pastPx:barEnd-barStart,futurePx:0,isFullyOverdue:true,isPartiallyOverdue:false};
  if(barStart>=todayPx)return{totalPx:barEnd-barStart,pastPx:0,futurePx:barEnd-barStart,isFullyOverdue:false,isPartiallyOverdue:false};
  const pp=todayPx-barStart;
  return{totalPx:barEnd-barStart,pastPx:pp,futurePx:barEnd-barStart-pp,isFullyOverdue:false,isPartiallyOverdue:pp>0};
}
function taskBelongsToWeek(t,off){return(t.week!==undefined?Number(t.week):0)===off;}
function isTaskOverdue(task,days){
  if(['Done','Cancelled'].includes(task.status))return false;
  const m=getOverdueMetrics(task,days);return m.isFullyOverdue||m.isPartiallyOverdue;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEFAULT DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getDefaultData(){return[
  {type:'domain',domain:'CORE BANKING'},
  {id:'ISS-HUB-001',name:'HUB Payment Buttons Fix ($loan undefined)',priority:'critical',start:0,dur:0.5,system:'PaymentsController.php:977',fix:'Fix $loan variable initialization',impact:'Blocks ALL reconciliation',owners:['Leo','Zayyad'],status:'Escalated',week:0},
  {id:'ISS-001',name:'Top-Up Loan Logic Error',priority:'critical',start:0.5,dur:0.8,system:'Helaplus Loan Disbursement',fix:'Offset only outstanding principal',impact:'Incorrect loan balances',owners:['Leo','Zayyad'],status:'In Progress',week:0},
  {id:'ISS-002',name:'Loan Tenure Mismatch (78 vs 10)',priority:'critical',start:3,dur:0.7,system:'Helaplus Schedule Engine',fix:'Tenure validation + lock after approval',impact:'Artificial arrears - PAR distortion',owners:['Leo','Zayyad'],status:'Investigating',week:0},
  {id:'ISS-004',name:'Boda Repossession Module (22 bikes)',priority:'high',start:1.5,dur:1,system:'Helaplus Asset Mgmt',fix:'Deploy repossession bucket',impact:'22 cases blocking',owners:['Leo','Zayyad'],status:'Pending',week:0},
  {id:'ISS-003',name:'Interest Rate Governance Controls',priority:'high',start:5,dur:0.8,system:'Helaplus Product Config',fix:'Rate change approval workflow',impact:'Compliance & audit exposure',owners:['IT Ops','Compliance'],status:'Documenting',week:0},
  {id:'ISS-010',name:'Manual Disbursement GL Visibility',priority:'medium',start:3.5,dur:0.5,system:'Helaplus GL Module',fix:'Fix GL posting for manual disbursements',impact:'Accounting gaps',owners:['Leo','Zayyad'],status:'Identified',week:0},
  {id:'ISS-011',name:'Savings-to-Loan Offset Process',priority:'medium',start:3.5,dur:0.5,system:'Helaplus Wallet/Loan',fix:'Define wallet-to-loan offset workflow',impact:'Delayed closures',owners:['Leo','Sharon'],status:'Pending',week:0},
  {id:'ISS-007',name:'Loan Schedule Date Misalignment',priority:'medium',start:4,dur:0.5,system:'Helaplus Schedule Engine',fix:'Fix date calculation',impact:'Client disputes',owners:['Leo','Zayyad'],status:'Identified',week:0},
  {id:'ISS-008',name:'Installment Sequencing Mismatch',priority:'medium',start:4.5,dur:0.5,system:'Helaplus Schedule Engine',fix:'Fix installment sequence',impact:'Schedule confusion',owners:['Leo','Zayyad'],status:'Identified',week:0},
  {id:'ISS-005',name:'Wallet Ledger/Sub-Ledger Design',priority:'design',start:5.5,dur:1,system:'Mifos X Wallet',fix:'Design wallet ledger linkage',impact:'Balance misrepresentation',owners:['Leo','Zayyad'],status:'Design Phase',week:0},
  {id:'ISS-006',name:'Standing Instructions Auto-Pay Fix',priority:'design',start:5.5,dur:1,system:'Mifos X Standing Instructions',fix:'Trigger only after deposit confirmation',impact:'Cash-flow distortion',owners:['Leo','Zayyad'],status:'Design Phase',week:0},
  {id:'ISS-009',name:'Product Parameterization Design',priority:'design',start:6,dur:0.8,system:'Helaplus Products',fix:'Parameterized product architecture',impact:'Product sprawl',owners:['IT Ops'],status:'Design Phase',week:0},
  {id:'ISS-013',name:'Loan Freeze Status Mechanism',priority:'design',start:6,dur:0.8,system:'Helaplus Loan Status',fix:'Implement freeze/hold status',impact:'Incorrect interest accrual',owners:['Leo','Zayyad'],status:'Pending',week:0},
  {type:'domain',domain:'HUB / RECONCILIATION'},
  {id:'ISS-HUB-002',name:'Airtel Withdraw Transaction Filter',priority:'critical',start:1,dur:0.5,system:'HUB CSV Parser',fix:'Add withdraw exclusion',impact:'Manual cleanup per upload',owners:['Leo','Zayyad'],status:'Identified',week:0},
  {id:'ISS-HUB-003',name:'Airtel Date Parsing Error',priority:'critical',start:1,dur:0.5,system:'HUB Date Parser',fix:'Fix Airtel date format parsing',impact:'Future dates - audit risk',owners:['Leo','Zayyad'],status:'Identified',week:0},
  {id:'ISS-HUB-004',name:'YO! Uganda CSV Upload Failure',priority:'critical',start:1.5,dur:0.5,system:'HUB CSV Parser',fix:'Implement YO! CSV format parser',impact:'YO! reconciliation blocked',owners:['Leo','Zayyad'],status:'In Progress',week:0},
  {id:'ISS-HUB-005',name:'Provider Misidentification (Airtel‚ÜíMTN)',priority:'high',start:2,dur:0.5,system:'HUB Provider Logic',fix:'Fix provider tagging logic',impact:'Incorrect attribution',owners:['Leo','Zayyad'],status:'Investigating',week:0},
  {id:'ISS-HUB-006',name:'USSD Down Payment Misrouting',priority:'high',start:2.5,dur:0.5,system:'HUB Payment Routing',fix:'Distinguish new loan vs repayment',impact:'Cross-account errors',owners:['Leo','Zayyad'],status:'Pending',week:0},
  {type:'domain',domain:'MIFOS X / API'},
  {id:'MF-002',name:'Product GL Mapping Error (All Boda)',priority:'high',start:2,dur:0.8,system:'Mifos X GL Mapping',fix:'Verify GL accounts + fix validation',impact:'Blocks all boda product config',owners:['Zayyad'],status:'Investigating',week:0},
  {id:'MF-001',name:'Client Transfer Date API Error',priority:'medium',start:5,dur:0.5,system:'Mifos X Client API',fix:'Remove transferDate or update API',impact:'Cannot schedule transfers',owners:['Zayyad'],status:'Done',week:0},
  {type:'domain',domain:'REPORTING & ANALYTICS'},
  {id:'RPT-003',name:'Aging Summary Returns Blank',priority:'high',start:2.5,dur:0.5,system:'Helaplus Reports',fix:'Debug query aggregation logic',impact:'Key report non-functional',owners:['Leo','Zayyad'],status:'In Progress',week:0},
  {id:'RPT-001',name:'Aging Reports - Date Range Filter',priority:'high',start:3,dur:0.5,system:'Helaplus Reports',fix:'Add date range parameters',impact:'No historical aging analysis',owners:['Leo','Zayyad'],status:'Identified',week:0},
  {id:'RPT-002',name:'Aging Reports - Product/Fund Filter',priority:'high',start:3,dur:0.5,system:'Helaplus Reports',fix:'Add product and fund filter params',impact:'No product-level aging',owners:['Leo','Zayyad'],status:'Identified',week:0},
  {id:'RPT-004',name:'Loans Due Today - Rolling Overdue',priority:'enhancement',start:4,dur:0.5,system:'Helaplus Reports',fix:'Include rolling overdue + date range',impact:'Limited collections support',owners:['Leo','Zayyad'],status:'Pending',week:0},
  {id:'RPT-005',name:'Rename Credit Analyst Reports',priority:'enhancement',start:4.5,dur:0.3,system:'Helaplus Reports',fix:'Rename + add CA Approved report',impact:'Workflow checkpoint unclear',owners:['Leo','Zayyad'],status:'Done',week:0},
  {id:'RPT-006',name:'Portfolio Historical View',priority:'enhancement',start:5,dur:0.5,system:'Helaplus Reports',fix:'Point-in-time portfolio snapshot',impact:'No trend analysis',owners:['Leo','Zayyad'],status:'Pending',week:0},
];}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function login(){
  const name=document.getElementById('loginName').value.trim();
  if(!name){showToast('Please enter your name','error');return;}
  currentUser=name;sessionStorage.setItem('novaUser',name);showBoard();syncFromSheet();
}
(function(){const n=sessionStorage.getItem('novaUser');if(n){currentUser=n;showBoard();syncFromSheet();}})();

function showBoard(){
  document.getElementById('loginOverlay').style.display='none';
  document.getElementById('syncBar').style.display='flex';
  document.getElementById('mainHeader').style.display='flex';
  document.getElementById('mainTabs').style.display='flex';
  document.getElementById('toolbar').style.display='flex';
  document.getElementById('userBadge').textContent=currentUser;
  applyTheme();applyColWidths();updateWeekUI();setupColResize();setupHorizSync();
  switchMainTab('gantt');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchMainTab(tab){
  activeMainTab=tab;
  document.querySelectorAll('.main-tab').forEach((el,i)=>el.classList.toggle('active',['gantt','kanban'][i]===tab));
  document.getElementById('ganttView').classList.toggle('active',tab==='gantt');
  document.getElementById('kanbanView').classList.toggle('active',tab==='kanban');
  document.getElementById('weekNav').style.display=tab==='kanban'?'none':'flex';
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COL WIDTHS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyColWidths(){
  const lhId=document.getElementById('lhId'),lhPri=document.getElementById('lhPri'),lhOwner=document.getElementById('lhOwner');
  if(!lhId)return;
  lhId.style.width=CW.id+'px';
  lhPri.style.width=CW.priority+'px';
  lhOwner.style.width=CW.owner+'px';
  document.getElementById('leftPanel').style.width=(CW.id+CW.name+CW.priority+CW.owner+2)+'px';
}
function setupColResize(){
  document.querySelectorAll('.col-resize').forEach(h=>{
    if(h._b)return;h._b=true;
    h.addEventListener('mousedown',e=>{
      e.preventDefault();e.stopPropagation();
      const col=h.dataset.col,sX=e.clientX,sW=CW[col];h.classList.add('active');
      const mv=ev=>{CW[col]=Math.max(60,sW+(ev.clientX-sX));applyColWidths();render();};
      const up=()=>{h.classList.remove('active');localStorage.setItem('novaCW',JSON.stringify(CW));document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);};
      document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HORIZ SYNC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupHorizSync(){
  const tb=document.getElementById('timelineBody'),thi=document.getElementById('timelineHeaderInner');
  if(!tb||!thi||tb._hb)return;tb._hb=true;
  tb.addEventListener('scroll',()=>{thi.style.transform=`translateX(-${tb.scrollLeft}px)`;});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WEEK NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function changeWeek(d){weekOffset+=d;updateWeekUI();render();}
function updateWeekUI(){
  const days=getWeekDays(weekOffset);
  const wn=weekOffset===0?'Week 1 (Base)':weekOffset>0?`Week ${weekOffset+1}`:`Week ‚àí${Math.abs(weekOffset)}`;
  document.getElementById('weekLabel').textContent=`${wn}  ¬∑  ${days[0].date} ‚Äì ${days[6].date}`;
  document.getElementById('weekSubtitle').textContent=`${days[0].date} ‚Äì ${days[6].date}, ${days[0].full.getFullYear()} ¬∑ Synced with Google Sheets`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function apiFetch(method,params={},body=null){
  const url=new URL(CONFIG.APPS_SCRIPT_URL);
  if(method==='GET'){Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));return(await fetch(url.toString())).json();}
  return(await fetch(CONFIG.APPS_SCRIPT_URL,{method:'POST',body:JSON.stringify({...body,key:CONFIG.SECRET_KEY,user:currentUser})})).json();
}
async function syncFromSheet(){
  if(isSyncing)return;isSyncing=true;setSyncStatus('syncing','Syncing‚Ä¶');
  try{
    const d=await apiFetch('GET',{action:'getTasks',key:CONFIG.SECRET_KEY});
    if(d.error)throw new Error(d.error);
    DATA=Array.isArray(d)&&d.length>0?d:getDefaultData();
    localStorage.setItem('novaGanttData',JSON.stringify(DATA));
    setSyncStatus('ok','Synced ¬∑ '+new Date().toLocaleTimeString());render();showToast('Board refreshed','info');
  }catch(e){setSyncStatus('error','Offline ‚Äî using cache');const c=localStorage.getItem('novaGanttData');DATA=c?JSON.parse(c):getDefaultData();render();}
  finally{isSyncing=false;}
}
async function pushAllToSheet(){
  setSyncStatus('syncing','Pushing‚Ä¶');
  try{const r=await apiFetch('POST',{},{action:'saveTasks',tasks:DATA});if(r.error)throw new Error(r.error);localStorage.setItem('novaGanttData',JSON.stringify(DATA));setSyncStatus('ok','Pushed ¬∑ '+new Date().toLocaleTimeString());showToast(`Pushed ${r.saved} rows`,'info');}
  catch(e){setSyncStatus('error','Push failed');showToast('Push failed: '+e.message,'error');}
}
async function pushTask(task){
  setSyncStatus('syncing','Saving‚Ä¶');
  try{const r=await apiFetch('POST',{},{action:'saveTask',task});if(r.error)throw new Error(r.error);localStorage.setItem('novaGanttData',JSON.stringify(DATA));setSyncStatus('ok','Saved ¬∑ '+new Date().toLocaleTimeString());}
  catch(e){setSyncStatus('error','Save failed');showToast('Save failed: '+e.message,'error');}
}
async function apiDeleteTask(id){
  try{await apiFetch('POST',{},{action:'deleteTask',taskId:id});localStorage.setItem('novaGanttData',JSON.stringify(DATA));setSyncStatus('ok','Deleted');}
  catch(e){setSyncStatus('error','Delete failed');}
}
async function loadComments(tid){
  const el=document.getElementById('tab-comments');el.innerHTML='<div class="skeleton"></div><div class="skeleton"></div>';
  try{renderComments(await apiFetch('GET',{action:'getComments',key:CONFIG.SECRET_KEY,taskId:tid}),tid);}
  catch(e){el.innerHTML='<p style="color:var(--critical);font-size:12px">Failed to load</p>';}
}
async function submitComment(tid){
  const ta=document.getElementById('commentInput');const text=ta.value.trim();if(!text)return;ta.disabled=true;
  try{await apiFetch('POST',{},{action:'addComment',taskId:tid,text});ta.value='';loadComments(tid);showToast('Comment added');}
  catch(e){showToast('Failed','error');}finally{ta.disabled=false;}
}
async function deleteComment(cid,tid){
  if(!confirm('Delete?'))return;
  try{await apiFetch('POST',{},{action:'deleteComment',commentId:cid});loadComments(tid);}catch(e){showToast('Failed','error');}
}
async function loadHistory(tid){
  const el=document.getElementById('tab-history');el.innerHTML='<div class="skeleton"></div><div class="skeleton"></div>';
  try{renderHistory(await apiFetch('GET',{action:'getHistory',key:CONFIG.SECRET_KEY,taskId:tid}));}
  catch(e){el.innerHTML='<p style="color:var(--critical);font-size:12px">Failed</p>';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê THEME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyTheme(){document.documentElement.setAttribute('data-theme',currentTheme);document.getElementById('themeBtn').textContent=currentTheme==='dark'?'‚òÄÔ∏è Light':'üåô Dark';}
function toggleTheme(){currentTheme=currentTheme==='dark'?'light':'dark';localStorage.setItem('novaTheme',currentTheme);applyTheme();}
function setSyncStatus(s,m){document.getElementById('syncDot').className='sync-dot '+s;document.getElementById('syncStatus').textContent=m;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStats(days){
  const c={};PRIORITIES.forEach(p=>c[p]=0);let od=0;
  const tasks=DATA.filter(d=>!d.type&&(activeMainTab==='kanban'||taskBelongsToWeek(d,weekOffset)));
  tasks.forEach(t=>{if(c[t.priority]!==undefined)c[t.priority]++;if(days&&isTaskOverdue(t,days))od++;});
  document.getElementById('ganttCount').textContent=DATA.filter(d=>!d.type&&taskBelongsToWeek(d,weekOffset)).length;
  document.getElementById('kanbanCount').textContent=DATA.filter(d=>!d.type).length;
  let html=PRIORITIES.map(p=>`<div class="stat-chip ${p}"><span class="dot"></span>${c[p]} ${PL[p]}</div>`).join('');
  if(od>0)html+=`<div class="stat-chip overdue"><span class="dot"></span>${od} Overdue</div>`;
  document.getElementById('statsBar').innerHTML=html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  const days=getWeekDays(weekOffset);updateStats(days);buildFilterBtns();
  if(activeMainTab==='gantt')renderGantt(days);else renderKanban();
}
function buildFilterBtns(){
  const fb=document.getElementById('filterBtns');fb.innerHTML='';
  ['all',...PRIORITIES].forEach(f=>{
    const b=document.createElement('button');
    b.className='filter-btn'+(f===currentFilter?' active '+(f!=='all'?f:''):'');
    b.textContent=f==='all'?'All Issues':PL[f];b.onclick=()=>{currentFilter=f;render();};
    fb.appendChild(b);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê KANBAN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dragSrcColId=null;

function renderKanban(){
  const board=document.getElementById('kanbanBoard');board.innerHTML='';
  const tasks=DATA.filter(d=>!d.type&&(currentFilter==='all'||d.priority===currentFilter));
  const cols=getKbCols();
  const weekDays=getWeekDays(weekOffset);

  cols.forEach(col=>{
    const colTasks=tasks.filter(t=>resolveStatus(t.status)===col.id);
    const colEl=document.createElement('div');
    colEl.className='kb-col';colEl.dataset.colId=col.id;

    // Header ‚Äî draggable
    const hdr=document.createElement('div');hdr.className='kb-col-header';
    hdr.draggable=true;
    hdr.innerHTML=`<span class="kb-col-dot" style="background:${col.dot}"></span><span class="kb-col-title">${col.icon} ${col.label}</span><span class="kb-col-count">${colTasks.length}</span><span class="kb-drag-hint">‚†ø</span>`;
    // Drag events on header
    hdr.addEventListener('dragstart',e=>{
      dragSrcColId=col.id;colEl.classList.add('col-dragging');
      e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',col.id);
    });
    hdr.addEventListener('dragend',()=>colEl.classList.remove('col-dragging'));
    colEl.addEventListener('dragover',e=>{
      e.preventDefault();e.dataTransfer.dropEffect='move';
      if(dragSrcColId&&dragSrcColId!==col.id)colEl.classList.add('col-drag-over');
    });
    colEl.addEventListener('dragleave',()=>colEl.classList.remove('col-drag-over'));
    colEl.addEventListener('drop',e=>{
      e.preventDefault();colEl.classList.remove('col-drag-over');
      if(!dragSrcColId||dragSrcColId===col.id)return;
      const from=kbColOrder.indexOf(dragSrcColId),to=kbColOrder.indexOf(col.id);
      if(from<0||to<0)return;
      kbColOrder.splice(from,1);kbColOrder.splice(to,0,dragSrcColId);
      localStorage.setItem('novaKbOrder',JSON.stringify(kbColOrder));
      dragSrcColId=null;renderKanban();
    });
    colEl.appendChild(hdr);

    // Cards
    const cardsEl=document.createElement('div');cardsEl.className='kb-cards';
    if(!colTasks.length){
      cardsEl.innerHTML='<div class="kb-empty">No tasks</div>';
    } else {
      // Sort by priority within column
      const sorted=[...colTasks].sort((a,b)=>PRIORITIES.indexOf(a.priority)-PRIORITIES.indexOf(b.priority));
      sorted.forEach(task=>{
        const overdue=isTaskOverdue(task,weekDays);
        const card=document.createElement('div');
        card.className=`kb-card ${task.priority}${overdue?' overdue-card':''}`;
        const owners=task.owners||[];
        const weekLabel=`W${(task.week||0)+1}`;
        // Owner avatars + names
        const ownerHtml=owners.map(o=>`<span class="kb-owner-dot" style="background:${oc(o)}" title="${esc(o)}">${esc(o).charAt(0)}</span>`).join('');
        const ownerNames=owners.length?`<span class="kb-owner-name">${esc(owners.join(', '))}</span>`:'';
        card.innerHTML=`
          <div class="kb-card-id">${esc(task.id)} ¬∑ ${weekLabel}</div>
          <div class="kb-card-name">${esc(task.name)}</div>
          ${task.system?`<div class="kb-card-system">${esc(task.system)}</div>`:''}
          <div class="kb-card-footer">
            <span class="kb-p-badge ${overdue?'overdue':task.priority}">${overdue?'OVERDUE':PS[task.priority]}</span>
            <div class="kb-owners">${ownerHtml}${ownerNames}</div>
            ${overdue?'<span class="kb-overdue-tag">‚ö† Overdue</span>':''}
          </div>`;
        card.onclick=()=>openPanel(task.id);
        cardsEl.appendChild(card);
      });
    }
    colEl.appendChild(cardsEl);
    board.appendChild(colEl);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GANTT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGantt(days){
  const TOTAL_W=days.length*DAY_W;
  const lb=document.getElementById('leftBody');lb.innerHTML='';
  const thi=document.getElementById('timelineHeaderInner');thi.innerHTML='';thi.style.width=TOTAL_W+'px';
  const tbi=document.getElementById('timelineBodyInner');tbi.innerHTML='';tbi.style.width=TOTAL_W+'px';
  const tbEl=document.getElementById('timelineBody');tbEl.scrollLeft=0;thi.style.transform='translateX(0)';

  days.forEach(d=>{
    const el=document.createElement('div');
    el.className='day-col-hdr'+(isToday(d.full)?' today-col':'');
    el.style.cssText=`width:${DAY_W}px;min-width:${DAY_W}px`;
    el.innerHTML=`<span class="day-name">${d.label}</span><span class="day-date">${d.date}</span>${isToday(d.full)?'<span class="today-badge">TODAY</span>':''}`;
    thi.appendChild(el);
  });

  const GH=10000;
  let todayPx=null;days.forEach((d,i)=>{if(isToday(d.full))todayPx=i*DAY_W;});
  days.forEach((_,i)=>{
    const g=document.createElement('div');g.className='g-day';g.style.cssText=`left:${(i+1)*DAY_W}px;height:${GH}px`;tbi.appendChild(g);
    const h=document.createElement('div');h.className='g-half';h.style.cssText=`left:${(i+0.5)*DAY_W}px;height:${GH}px`;tbi.appendChild(h);
    if(isToday(days[i].full)){const t=document.createElement('div');t.className='g-today';t.style.cssText=`left:${(i+1)*DAY_W-1}px;height:${GH}px`;tbi.appendChild(t);}
  });
  if(todayPx!==null&&todayPx>0){const p=document.createElement('div');p.className='g-past';p.style.cssText=`width:${todayPx}px;height:${GH}px`;tbi.appendChild(p);}
  else if(todayPx===null&&days.every(d=>isPast(d.full))){const p=document.createElement('div');p.className='g-past';p.style.cssText=`width:${TOTAL_W}px;height:${GH}px`;tbi.appendChild(p);}

  let visible=0;
  DATA.forEach(item=>{
    if(item.type==='domain'){
      let hv=false;const di=DATA.indexOf(item);
      for(let i=di+1;i<DATA.length;i++){if(DATA[i].type==='domain')break;if(taskBelongsToWeek(DATA[i],weekOffset)&&(currentFilter==='all'||DATA[i].priority===currentFilter)){hv=true;break;}}
      if(!hv)return;
      const dr=document.createElement('div');dr.className='left-domain-row';dr.textContent=item.domain;lb.appendChild(dr);
      const tr=document.createElement('div');tr.className='tl-domain-row';tr.style.width=TOTAL_W+'px';tbi.appendChild(tr);
      return;
    }
    if(!taskBelongsToWeek(item,weekOffset)||(currentFilter!=='all'&&item.priority!==currentFilter))return;
    visible++;
    const overdue=isTaskOverdue(item,days),m=getOverdueMetrics(item,days);

    // Left row
    const lrow=document.createElement('div');
    lrow.className='left-task-row'+(selectedTaskId===item.id?' selected':'')+(overdue?' row-overdue':'');
    const cId=document.createElement('div');cId.className='ltr-cell';cId.style.width=CW.id+'px';
    cId.innerHTML=`<span class="task-id-txt">${esc(item.id)}</span>`;lrow.appendChild(cId);
    const cName=document.createElement('div');cName.className='ltr-cell ltr-name';cName.style.width=CW.name+'px';
    cName.innerHTML=`<span class="task-name-txt${overdue?' overdue-name':''}" title="${esc(item.name)}">${esc(item.name)}</span>`;lrow.appendChild(cName);
    const cPri=document.createElement('div');cPri.className='ltr-cell';cPri.style.width=CW.priority+'px';
    cPri.innerHTML=`<span class="p-badge ${overdue?'overdue':item.priority}">${overdue?'OVERDUE':PS[item.priority]}</span>`;lrow.appendChild(cPri);
    const cOwn=document.createElement('div');cOwn.className='ltr-cell';cOwn.style.width=CW.owner+'px';
    const owners=item.owners||[];
    cOwn.innerHTML=`<div class="owner-cell-inner">${owners.map(o=>`<span class="owner-pip"><span class="owner-dot" style="background:${oc(o)}"></span>${esc(o)}</span>`).join('')||'<em style="opacity:.4;font-size:11px">‚Äî</em>'}</div>`;
    lrow.appendChild(cOwn);
    lrow.onclick=()=>openPanel(item.id);lb.appendChild(lrow);

    // Timeline row + bar
    const trow=document.createElement('div');trow.className='tl-task-row'+(overdue?' row-overdue':'');trow.style.width=TOTAL_W+'px';
    const bar=document.createElement('div');
    bar.className=`gantt-bar ${item.priority}${m.isFullyOverdue?' bar-overdue':''}`;
    bar.style.left=(item.start*DAY_W)+'px';bar.style.width=Math.max(item.dur*DAY_W,28)+'px';
    if(m.isPartiallyOverdue&&m.pastPx>0){const po=document.createElement('div');po.className='bar-past-overlay';po.style.width=Math.min(m.pastPx,parseFloat(bar.style.width))+'px';bar.appendChild(po);}
    if(item.status){const st=document.createElement('span');st.className='bar-status';st.textContent=item.status==='Done'?'‚úì':item.status==='Cancelled'?'‚úó':item.status==='In Progress'?'‚ñ∂':'';if(st.textContent)bar.appendChild(st);}
    bar.insertBefore(document.createTextNode(item.id),bar.firstChild);
    const lh=document.createElement('div');lh.className='bar-rz l';
    const rh=document.createElement('div');rh.className='bar-rz r';
    bar.appendChild(lh);bar.appendChild(rh);
    // drag move
    bar.addEventListener('mousedown',e=>{
      if(e.target.classList.contains('bar-rz'))return;e.preventDefault();
      const oL=item.start*DAY_W,sX=e.clientX;bar.classList.add('dragging');
      const mv=ev=>{let nl=Math.max(0,oL+ev.clientX-sX);nl=Math.min(nl,TOTAL_W-parseFloat(bar.style.width));bar.style.left=nl+'px';};
      const up=()=>{bar.classList.remove('dragging');const t=DATA.find(d=>d.id===item.id);if(t){t.start=Math.round(parseFloat(bar.style.left)/DAY_W*4)/4;pushTask(t);render();}document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);};
      document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
    });
    lh.addEventListener('mousedown',e=>{
      e.preventDefault();e.stopPropagation();
      const oS=item.start,oD=item.dur,sX=e.clientX;bar.classList.add('dragging');
      const mv=ev=>{const dd=(ev.clientX-sX)/DAY_W;let ns=Math.max(0,oS+dd),nd=oD-(ns-oS);if(nd<0.15){nd=0.15;ns=oS+oD-0.15;}bar.style.left=(ns*DAY_W)+'px';bar.style.width=Math.max(nd*DAY_W,28)+'px';};
      const up=()=>{bar.classList.remove('dragging');const t=DATA.find(d=>d.id===item.id);if(t){t.start=Math.round(parseFloat(bar.style.left)/DAY_W*4)/4;t.dur=Math.round(parseFloat(bar.style.width)/DAY_W*4)/4;if(t.dur<0.15)t.dur=0.15;pushTask(t);render();}document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);};
      document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
    });
    rh.addEventListener('mousedown',e=>{
      e.preventDefault();e.stopPropagation();
      const oW=item.dur*DAY_W,sX=e.clientX;bar.classList.add('dragging');
      const mv=ev=>{let nw=Math.max(28,oW+ev.clientX-sX);nw=Math.min(nw,TOTAL_W-item.start*DAY_W);bar.style.width=nw+'px';};
      const up=()=>{bar.classList.remove('dragging');const t=DATA.find(d=>d.id===item.id);if(t){t.dur=Math.round(parseFloat(bar.style.width)/DAY_W*4)/4;if(t.dur<0.15)t.dur=0.15;pushTask(t);render();}document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);};
      document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
    });
    bar.addEventListener('dblclick',()=>openPanel(item.id));
    bar.addEventListener('mouseenter',e=>showTT(e,item,days,m));
    bar.addEventListener('mouseleave',()=>document.getElementById('tt').classList.remove('show'));
    bar.addEventListener('mousemove',moveTT);
    trow.appendChild(bar);tbi.appendChild(trow);
  });

  if(!visible){
    const ew=document.createElement('div');ew.className='empty-week';
    ew.innerHTML=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>No tasks for this week</span>`;
    lb.appendChild(ew);const et=document.createElement('div');et.style.cssText=`width:${TOTAL_W}px;height:200px`;tbi.appendChild(et);
  }
  bindScrollSync();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCROLL SYNC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _vL=false;
function bindScrollSync(){
  const lb=document.getElementById('leftBody'),tb=document.getElementById('timelineBody');
  if(!lb||!tb)return;
  lb._vs&&lb.removeEventListener('scroll',lb._vs);tb._vs&&tb.removeEventListener('scroll',tb._vs);
  lb._vs=()=>{if(_vL)return;_vL=true;tb.scrollTop=lb.scrollTop;_vL=false;};
  tb._vs=()=>{if(_vL)return;_vL=true;lb.scrollTop=tb.scrollTop;_vL=false;};
  lb.addEventListener('scroll',lb._vs);tb.addEventListener('scroll',tb._vs);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab){
  document.querySelectorAll('.panel-tab').forEach((el,i)=>el.classList.toggle('active',['details','comments','history'][i]===tab));
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  if(tab==='comments'&&selectedTaskId)loadComments(selectedTaskId);
  if(tab==='history'&&selectedTaskId)loadHistory(selectedTaskId);
}
function openPanel(id){
  const task=DATA.find(d=>d.id===id);if(!task)return;
  selectedTaskId=id;
  document.getElementById('panelTitle').textContent=task.name;
  document.getElementById('panelId').textContent=task.id;
  document.querySelectorAll('.panel-tab').forEach((el,i)=>el.classList.toggle('active',i===0));
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-details').classList.add('active');
  const owners=task.owners||[];
  document.getElementById('tab-details').innerHTML=`
    <div class="field-row">
      <div class="field-group"><label class="field-label">Issue ID</label><input class="field-input" id="ed_id" value="${esc(task.id)}"></div>
      <div class="field-group"><label class="field-label">Week (0=W1‚Ä¶)</label><input class="field-input" id="ed_week" type="number" min="0" step="1" value="${task.week!==undefined?task.week:0}"></div>
    </div>
    <div class="field-group"><label class="field-label">Title / Issue</label><input class="field-input" id="ed_name" value="${esc(task.name)}"></div>
    <div class="field-row">
      <div class="field-group"><label class="field-label">Priority</label><select class="field-input" id="ed_priority">${PRIORITIES.map(p=>`<option value="${p}"${task.priority===p?' selected':''}>${PL[p]}</option>`).join('')}</select></div>
      <div class="field-group"><label class="field-label">Status</label><select class="field-input" id="ed_status">${ALL_STATUSES.map(s=>`<option value="${s}"${(task.status||'')=== s?' selected':''}>${s}</option>`).join('')}</select></div>
    </div>
    <div class="field-row">
      <div class="field-group"><label class="field-label">Start Day (0‚Äì6)</label><input class="field-input" id="ed_start" type="number" min="0" max="6.75" step="0.25" value="${task.start}"></div>
      <div class="field-group"><label class="field-label">Duration (days)</label><input class="field-input" id="ed_dur" type="number" min="0.25" max="7" step="0.25" value="${task.dur}"></div>
    </div>
    <div class="field-group"><label class="field-label">System / Component</label><input class="field-input" id="ed_system" value="${esc(task.system||'')}"></div>
    <div class="field-group"><label class="field-label">Required Fix</label><textarea class="field-input" id="ed_fix">${esc(task.fix||'')}</textarea></div>
    <div class="field-group"><label class="field-label">Business Impact</label><textarea class="field-input" id="ed_impact">${esc(task.impact||'')}</textarea></div>
    <div class="field-group"><label class="field-label">Owners</label>
      <div class="owners-container">${owners.map((o,i)=>`<span class="owner-chip"><span class="owner-dot" style="background:${oc(o)}"></span>${esc(o)}<button class="rm" onclick="removeOwner(${i})">‚úï</button></span>`).join('')}</div>
      <div class="add-row"><input class="add-inp" id="newOwnerInput" placeholder="Add owner‚Ä¶" onkeydown="if(event.key==='Enter')addOwner()"><button class="btn" onclick="addOwner()" style="padding:6px 12px;font-size:11px">Add</button></div>
    </div>
    ${task.updatedBy?`<p style="font-size:9px;color:var(--text-dim);margin-top:10px">Last updated by <strong>${esc(task.updatedBy)}</strong> ¬∑ ${task.updatedAt||''}</p>`:''}`;
  document.getElementById('panelOverlay').classList.add('open');
  document.getElementById('sidePanel').classList.add('open');
  render();
}
function closePanel(){document.getElementById('panelOverlay').classList.remove('open');document.getElementById('sidePanel').classList.remove('open');selectedTaskId=null;render();}
async function savePanel(){
  const task=DATA.find(d=>d.id===selectedTaskId);if(!task)return;
  const nid=document.getElementById('ed_id').value.trim();
  if(nid&&nid!==task.id){task.id=nid;selectedTaskId=nid;}
  task.name=document.getElementById('ed_name').value;
  task.priority=document.getElementById('ed_priority').value;
  task.status=document.getElementById('ed_status').value;
  task.start=parseFloat(document.getElementById('ed_start').value)||0;
  task.dur=parseFloat(document.getElementById('ed_dur').value)||0.25;
  task.system=document.getElementById('ed_system').value;
  task.fix=document.getElementById('ed_fix').value;
  task.impact=document.getElementById('ed_impact').value;
  task.week=parseInt(document.getElementById('ed_week').value)||0;
  task.updatedBy=currentUser;task.updatedAt=new Date().toLocaleString();
  await pushTask(task);showToast('Saved & synced');
  document.getElementById('panelTitle').textContent=task.name;render();
}
async function deleteTask(){
  if(!selectedTaskId||!confirm(`Delete ${selectedTaskId}?`))return;
  DATA=DATA.filter(d=>d.id!==selectedTaskId);await apiDeleteTask(selectedTaskId);closePanel();showToast('Deleted');
}
function addOwner(){const inp=document.getElementById('newOwnerInput');const n=inp.value.trim();if(!n)return;const t=DATA.find(d=>d.id===selectedTaskId);if(!t)return;if(!t.owners)t.owners=[];if(!t.owners.includes(n))t.owners.push(n);inp.value='';openPanel(selectedTaskId);}
function removeOwner(i){const t=DATA.find(d=>d.id===selectedTaskId);if(!t||!t.owners)return;t.owners.splice(i,1);openPanel(selectedTaskId);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMMENTS / HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderComments(comments,tid){
  const el=document.getElementById('tab-comments');let h='';
  if(!comments||!comments.length)h='<p style="color:var(--text-muted);font-size:12px;margin-bottom:16px">No comments yet.</p>';
  else comments.forEach(c=>{h+=`<div class="comment"><div class="comment-header"><span class="comment-author">${esc(c.author)}</span><span class="comment-ts">${c.timestamp?new Date(c.timestamp).toLocaleString():''}</span></div><div class="comment-text">${esc(c.text)}</div>${c.author===currentUser?`<button class="comment-del" onclick="deleteComment('${esc(c.id)}','${esc(tid)}')">Delete</button>`:''}</div>`;});
  h+=`<div class="comment-form" style="margin-top:16px"><textarea id="commentInput" placeholder="Add a comment‚Ä¶"></textarea><div style="display:flex;justify-content:flex-end;margin-top:6px"><button class="btn primary" style="font-size:11px;padding:6px 14px" onclick="submitComment('${esc(tid)}')">Post</button></div></div>`;
  el.innerHTML=h;
}
const AICONS={update:'‚úèÔ∏è',create:'‚úÖ',delete:'üóëÔ∏è',bulk_save:'üíæ',comment_add:'üí¨'};
function renderHistory(items){
  const el=document.getElementById('tab-history');
  if(!items||!items.length){el.innerHTML='<p style="color:var(--text-muted);font-size:12px">No history yet.</p>';return;}
  el.innerHTML=items.map(h=>`<div class="history-item"><div class="history-icon">${AICONS[h.action]||'‚Ä¢'}</div><div><div class="history-action">${h.action.replace(/_/g,' ')}${h.fieldName?' ‚Äî '+h.fieldName:''}</div><div class="history-meta">by <strong>${esc(h.changedBy)}</strong> ¬∑ ${h.timestamp?new Date(h.timestamp).toLocaleString():''}</div>${h.oldValue||h.newValue?`<div class="history-diff">${h.oldValue?`<span class="h-old">${esc(String(h.oldValue).slice(0,50))}</span>`:''} ${h.newValue?`<span class="h-new">${esc(String(h.newValue).slice(0,50))}</span>`:''}</div>`:''}</div></div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddModal(){
  const domains=DATA.filter(d=>d.type==='domain').map(d=>d.domain);
  document.getElementById('addModalBody').innerHTML=`
    <div class="field-row">
      <div class="field-group"><label class="field-label">Issue ID</label><input class="field-input" id="n_id" placeholder="ISS-NEW-001"></div>
      <div class="field-group"><label class="field-label">Domain</label><select class="field-input" id="n_domain" onchange="document.getElementById('nDG').style.display=this.value==='__new'?'block':'none'">${domains.map(d=>`<option>${d}</option>`).join('')}<option value="__new">+ New Domain‚Ä¶</option></select></div>
    </div>
    <div class="field-group" id="nDG" style="display:none"><label class="field-label">New Domain Name</label><input class="field-input" id="n_domname"></div>
    <div class="field-group"><label class="field-label">Title / Issue</label><input class="field-input" id="n_name"></div>
    <div class="field-row">
      <div class="field-group"><label class="field-label">Priority</label><select class="field-input" id="n_priority">${PRIORITIES.map(p=>`<option value="${p}">${PL[p]}</option>`).join('')}</select></div>
      <div class="field-group"><label class="field-label">Status</label><select class="field-input" id="n_status">${ALL_STATUSES.map(s=>`<option>${s}</option>`).join('')}</select></div>
    </div>
    <div class="field-row">
      <div class="field-group"><label class="field-label">Week (0=W1‚Ä¶)</label><input class="field-input" id="n_week" type="number" min="0" step="1" value="${weekOffset}"></div>
      <div class="field-group"><label class="field-label">Start Day (0‚Äì6)</label><input class="field-input" id="n_start" type="number" min="0" max="6.75" step="0.25" value="0"></div>
    </div>
    <div class="field-group"><label class="field-label">Duration (days)</label><input class="field-input" id="n_dur" type="number" min="0.25" max="7" step="0.25" value="0.5"></div>
    <div class="field-group"><label class="field-label">System / Component</label><input class="field-input" id="n_system"></div>
    <div class="field-group"><label class="field-label">Required Fix</label><textarea class="field-input" id="n_fix"></textarea></div>
    <div class="field-group"><label class="field-label">Business Impact</label><textarea class="field-input" id="n_impact"></textarea></div>
    <div class="field-group"><label class="field-label">Owners (comma-separated)</label><input class="field-input" id="n_owners" placeholder="Leo, Zayyad"></div>`;
  document.getElementById('addModal').classList.add('open');
}
function closeAddModal(){document.getElementById('addModal').classList.remove('open');}
async function addNewTask(){
  const id=document.getElementById('n_id').value.trim(),name=document.getElementById('n_name').value.trim();
  if(!id||!name){showToast('ID and Title required','error');return;}
  let domain=document.getElementById('n_domain').value;
  if(domain==='__new'){domain=document.getElementById('n_domname').value.trim().toUpperCase();if(!domain){showToast('Enter domain name','error');return;}if(!DATA.find(d=>d.type==='domain'&&d.domain===domain))DATA.push({type:'domain',domain});}
  const task={id,name,priority:document.getElementById('n_priority').value,status:document.getElementById('n_status').value,
    week:parseInt(document.getElementById('n_week').value)||0,
    start:parseFloat(document.getElementById('n_start').value)||0,dur:parseFloat(document.getElementById('n_dur').value)||0.5,
    system:document.getElementById('n_system').value,fix:document.getElementById('n_fix').value,impact:document.getElementById('n_impact').value,
    owners:document.getElementById('n_owners').value.split(',').map(s=>s.trim()).filter(Boolean)};
  let ins=DATA.findIndex(d=>d.type==='domain'&&d.domain===domain);
  if(ins>=0){ins++;while(ins<DATA.length&&!DATA[ins].type)ins++;DATA.splice(ins,0,task);}else DATA.push(task);
  await pushTask(task);closeAddModal();showToast(`${id} added`,'info');render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOOLTIP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTT(e,item,days,m){
  const tt=document.getElementById('tt');
  const sd=days[Math.floor(item.start)]||days[0];
  const ed=days[Math.min(Math.ceil(item.start+item.dur)-1,days.length-1)];
  const overdue=m&&(m.isFullyOverdue||m.isPartiallyOverdue)&&!['Done','Cancelled'].includes(item.status);
  tt.innerHTML=`<div class="tt-title">${esc(item.name)}</div>
    <div class="tt-row"><span class="tt-lbl">ID</span><span class="tt-val">${esc(item.id)}</span></div>
    <div class="tt-row"><span class="tt-lbl">Priority</span><span class="tt-val">${PL[item.priority]}</span></div>
    <div class="tt-row"><span class="tt-lbl">Status</span><span class="tt-val">${esc(item.status||'‚Äî')}</span></div>
    <div class="tt-row"><span class="tt-lbl">Timeline</span><span class="tt-val">${sd.label} ‚Üí ${ed.label}</span></div>
    <div class="tt-row"><span class="tt-lbl">Duration</span><span class="tt-val">${item.dur}d</span></div>
    ${item.owners&&item.owners.length?`<div class="tt-row"><span class="tt-lbl">Owners</span><span class="tt-val">${item.owners.join(', ')}</span></div>`:''}
    ${overdue?`<div class="tt-overdue">‚ö† ${m.isFullyOverdue?'Past due date':'Partially overdue'}</div>`:''}`;
  tt.classList.add('show');moveTT(e);
}
function moveTT(e){const tt=document.getElementById('tt');if(tt.classList.contains('show')){tt.style.left=(e.clientX+14)+'px';tt.style.top=(e.clientY+14)+'px';}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportJSON(){const b=new Blob([JSON.stringify(DATA,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='nova_gantt_'+new Date().toISOString().slice(0,10)+'.json';a.click();showToast('Exported');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _tt2;
function showToast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast'+(type?' '+type:'');void t.offsetWidth;t.classList.add('show');clearTimeout(_tt2);_tt2=setTimeout(()=>t.classList.remove('show'),3000);}
</script>
</body>
</html>
